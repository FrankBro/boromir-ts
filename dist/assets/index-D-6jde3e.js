var st=Object.defineProperty;var rt=(e,t,i)=>t in e?st(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var T=(e,t,i)=>rt(e,typeof t!="symbol"?t+"":t,i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function i(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(s){if(s.ep)return;s.ep=!0;const n=i(s);fetch(s.href,n)}})();var B=(e,t,i,r)=>{for(var s=t,n=e.length-1,a;n>=0;n--)(a=e[n])&&(s=a(s)||s);return s};function o(e,t,i,r){return r===void 0&&(r=255),(e<<24)+(t<<16)+(i<<8)+r}var O={BLACK:o(0,0,0),WHITE:o(255,255,255),LIGHT_GRAY:o(170,170,170),DARK_GRAY:o(85,85,85),YELLOW:o(255,255,85),BROWN:o(170,85,0),LIGHT_RED:o(255,85,85),DARK_RED:o(170,0,0),LIGHT_GREEN:o(85,255,85),DARK_GREEN:o(0,170,0),LIGHT_CYAN:o(85,255,255),DARK_CYAN:o(0,170,170),LIGHT_BLUE:o(85,85,255),DARK_BLUE:o(0,0,170),LIGHT_MAGENTA:o(255,85,255),DARK_MAGENTA:o(170,0,170),ORANGE:o(255,136,0)},nt=new Map;function K(e){nt.set(e.name,e)}function at(e){return typeof e=="string"&&e.length>0?e.charCodeAt(0):e}var V=class{constructor(e,t,i,r=O.WHITE,s=O.BLACK){this.x=e,this.y=t,i!==void 0?this.charCode=at(i):this.charCode=32,this.fg=r,this.bg=s,this.dirty=!0,this.blocked=!1,this.blockedSight=!1,this.explored=!1,this.visible=!1,this.pathId=-1,this.g=0,this.h=0,this.prev=null}setCharCode(e){this.charCode!==e&&(this.charCode=e,this.dirty=!0)}setForeground(e){e!=null&&e!==this.fg&&(this.fg=e,this.dirty=!0)}setBackground(e){e!=null&&e!==this.bg&&(this.bg=e,this.dirty=!0)}setValue(e,t,i){return typeof e=="string"&&(e=e.charCodeAt(0)),typeof e=="number"?(this.setCharCode(e),t!==void 0&&this.setForeground(t),i!==void 0&&this.setBackground(i)):this.drawCell(e),this.dirty}drawCell(e,t){let i=e.bg&255;!t||e.charCode>0?(this.setCharCode(e.charCode),this.setForeground(e.fg)):i>0&&i<255&&this.setForeground(this.blendColors(this.fg,e.bg,t)),!t||i===255?this.setBackground(e.bg):i>0&&this.setBackground(this.blendColors(this.bg,e.bg,t))}blendColors(e,t,i){let r=(255-(t&255))/255,s=1-r,n=e>>24&255,a=e>>16&255,l=e>>8&255,u=t>>24&255,h=t>>16&255,_=t>>8&255;switch(i){case"blend":return o(r*n+s*u|0,r*a+s*h|0,r*l+s*_|0);case"add":return o(this.clamp(n+s*u|0),this.clamp(a+s*h|0),this.clamp(l+s*_|0));default:return t}}clamp(e){return Math.min(255,e)}};V=B([K],V);var L={SMILEY:1,INVERSE_SMILEY:2,HEART:3,DIAMOND:4,CLUB:5,SPADE:6,BULLET:7,INVERSE_BULLET:8,LIGHT_SHADE:176,MEDIUM_SHADE:177,DARK_SHADE:178,BOX_SINGLE_VERTICAL:179,BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT:180,BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT:185,BOX_DOUBLE_VERTICAL:186,BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT:187,BOX_DOUBLE_UP_AND_DOUBLE_LEFT:188,BOX_SINGLE_DOWN_AND_SINGLE_LEFT:191,BOX_SINGLE_UP_AND_SINGLE_RIGHT:192,BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP:193,BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN:194,BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT:195,BOX_SINGLE_HORIZONTAL:196,BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL:197,BOX_DOUBLE_UP_AND_DOUBLE_RIGHT:200,BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT:201,BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP:202,BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN:203,BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT:204,BOX_DOUBLE_HORIZONTAL:205,BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL:206,BOX_SINGLE_UP_AND_SINGLE_LEFT:217,BOX_SINGLE_DOWN_AND_SINGLE_RIGHT:218,BLOCK_FULL:219,BLOCK_BOTTOM_HALF:220,BLOCK_LEFT_HALF:221,BLOCK_RIGHT_HALF:222,BLOCK_TOP_HALF:223},G={LEFT:"left",CENTER:"center",RIGHT:"right"},M=class{constructor(e,t,i,r,s){this.text=e,this.fg=t,this.bg=i,this.children=r,this.align=s}getWidth(){let e=0;if(this.text)for(let t of this.text.split(`
`))e=Math.max(e,t.length);if(this.children)for(let t of this.children)e=Math.max(e,t.getWidth());return e}getHeight(){let e=0;if(this.text&&(e+=this.text.split(`
`).length),this.children)for(let t of this.children)e+=t.getHeight();return e}};M=B([K],M);function ot(e,t){let i=new RegExp("(\\S(.{0,"+t+"}\\S)?)\\s+","g");return(e+" ").replace(i,`$1
`).trim().split(`
`).map(r=>r.trim())}var F=class{constructor(e,t,i){this.width=e,this.height=t,this.grid=[],this.originX=0,this.originY=0,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.radius=0;for(let r=0;r<t;r++){let s=[];for(let n=0;n<e;n++)s.push(new V(n,r));this.grid.push(s)}if(this.clear(),i)for(let r=0;r<t;r++)for(let s=0;s<e;s++)this.grid[r][s].blocked=this.grid[r][s].blockedSight=i(s,r)}clear(){for(let e=0;e<this.height;e++)for(let t=0;t<this.width;t++)this.drawChar(t,e,0)}getCell(e,t){if(!(e<0||t<0||e>=this.width||t>=this.height))return this.grid[t][e]}getCharCode(e,t){if(!(e<0||t<0||e>=this.width||t>=this.height))return this.grid[t][e].charCode}drawChar(e,t,i,r,s){this.clip&&!this.clip.contains({x:e,y:t})||e>=0&&e<this.width&&t>=0&&t<this.height&&this.grid[t|0][e|0].setValue(i,r,s)}drawString(e,t,i,r,s){let n=i.split(`
`);for(let a=0;a<n.length;a++)this.drawStringLine(e,t+a,n[a],r,s)}drawStringLine(e,t,i,r,s){for(let n=0;n<i.length;n++)this.drawChar(e+n,t,i.charCodeAt(n),r,s)}drawCenteredString(e,t,i,r,s){this.drawString(e-Math.floor(i.length/2),t,i,r,s)}drawMessage(e,t,i,r){if(i.text){i.align===G.RIGHT?e+=r-i.text.length:i.align===G.CENTER&&(e+=r/2-i.text.length/2);let s=ot(i.text,r||this.width-e);for(let n of s)this.drawStringLine(e,t,n,i.fg,i.bg),t++}if(i.children)for(let s of i.children)t=this.drawMessage(e,t,s,r);return t}drawHLine(e,t,i,r,s,n){for(let a=e;a<e+i;a++)this.drawChar(a,t,r,s,n)}drawVLine(e,t,i,r,s,n){for(let a=t;a<t+i;a++)this.drawChar(e,a,r,s,n)}drawRect(e,t,i,r,s,n,a){this.drawHLine(e,t,i,s,n,a),this.drawHLine(e,t+r-1,i,s,n,a),this.drawVLine(e,t,r,s,n,a),this.drawVLine(e+i-1,t,r,s,n,a)}drawBox(e,t,i,r,s,n,a,l,u,h,_,c,d,E){this.drawHLine(e,t,i,s,d,E),this.drawHLine(e,t+r-1,i,a,d,E),this.drawVLine(e,t,r,l,d,E),this.drawVLine(e+i-1,t,r,n,d,E),this.drawChar(e,t,u,d,E),this.drawChar(e+i-1,t,h,d,E),this.drawChar(e,t+r-1,c,d,E),this.drawChar(e+i-1,t+r-1,_,d,E)}drawSingleBox(e,t,i,r,s,n){this.drawBox(e,t,i,r,L.BOX_SINGLE_HORIZONTAL,L.BOX_SINGLE_VERTICAL,L.BOX_SINGLE_HORIZONTAL,L.BOX_SINGLE_VERTICAL,L.BOX_SINGLE_DOWN_AND_SINGLE_RIGHT,L.BOX_SINGLE_DOWN_AND_SINGLE_LEFT,L.BOX_SINGLE_UP_AND_SINGLE_LEFT,L.BOX_SINGLE_UP_AND_SINGLE_RIGHT,s,n)}drawDoubleBox(e,t,i,r,s,n){this.drawBox(e,t,i,r,L.BOX_DOUBLE_HORIZONTAL,L.BOX_DOUBLE_VERTICAL,L.BOX_DOUBLE_HORIZONTAL,L.BOX_DOUBLE_VERTICAL,L.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT,L.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT,L.BOX_DOUBLE_UP_AND_DOUBLE_LEFT,L.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT,s,n)}fillRect(e,t,i,r,s,n,a){for(let l=t;l<t+r;l++)this.drawHLine(e,l,i,s,n,a)}drawConsole(e,t,i,r,s,n,a,l){for(let u=0;u<a;u++)for(let h=0;h<n;h++){let _=i.getCell(r+h,s+u);_&&this.drawCell(e+h,t+u,_,l)}}drawCell(e,t,i,r){e>=0&&e<this.width&&t>=0&&t<this.height&&this.grid[t][e].drawCell(i,r)}setBlocked(e,t,i){e>=0&&e<this.width&&t>=0&&t<this.height&&(this.grid[t][e].blocked=i)}setBlockedSight(e,t,i){e>=0&&e<this.width&&t>=0&&t<this.height&&(this.grid[t][e].blockedSight=i)}isVisible(e,t){return e<this.minX||e>this.maxX||t<this.minY||t>this.maxY?!1:this.grid[t][e].visible}isBlocked(e,t){return e<0||e>this.width||t<0||t>this.height?!0:this.grid[t][e].blocked}isBlockedSight(e,t){return e<0||e>this.width||t<0||t>this.height?!0:this.grid[t][e].blockedSight}computeOctantY(e,t){let i=[],r=[],s=1,n=0,a=0,l=0,u,h,_,c,d,E,x,R,f,p;for(h=this.originY+t;h>=this.minY&&h<=this.maxY;h+=t,a=n,++s)for(_=.5/s,p=-1,c=Math.floor(l*s+.5),u=this.originX+c*e;c<=s&&u>=this.minX&&u<=this.maxX;u+=e,++c,p=f){if(d=!0,E=!1,x=c/s,R=p,f=x+_,a>0){if(!(this.grid[h-t][u].visible&&!this.grid[h-t][u].blockedSight)&&!(this.grid[h-t][u-e].visible&&!this.grid[h-t][u-e].blockedSight))d=!1;else for(let m=0;m<a&&d;++m)if(R<=r[m]&&f>=i[m]){if(this.grid[h][u].blockedSight)if(R>=i[m]&&f<=r[m]){d=!1;break}else i[m]=Math.min(i[m],R),r[m]=Math.max(r[m],f),E=!0;else if(x>i[m]&&x<r[m]){d=!1;break}}}d&&(this.grid[h][u].visible=!0,this.grid[h][u].blockedSight&&(l>=R?l=f:E||(i[n]=R,r[n++]=f)))}}computeOctantX(e,t){let i=[],r=[],s=1,n=0,a=0,l=0,u,h,_,c,d,E,x,R,f,p;for(u=this.originX+e;u>=this.minX&&u<=this.maxX;u+=e,a=n,++s)for(_=.5/s,p=-1,c=Math.floor(l*s+.5),h=this.originY+c*t;c<=s&&h>=this.minY&&h<=this.maxY;h+=t,++c,p=f){if(d=!0,E=!1,x=c/s,R=p,f=x+_,a>0){if(!(this.grid[h][u-e].visible&&!this.grid[h][u-e].blockedSight)&&!(this.grid[h-t][u-e].visible&&!this.grid[h-t][u-e].blockedSight))d=!1;else for(let m=0;m<a&&d;++m)if(R<=r[m]&&f>=i[m]){if(this.grid[h][u].blockedSight)if(R>=i[m]&&f<=r[m]){d=!1;break}else i[m]=Math.min(i[m],R),r[m]=Math.max(r[m],f),E=!0;else if(x>i[m]&&x<r[m]){d=!1;break}}}d&&(this.grid[h][u].visible=!0,this.grid[h][u].blockedSight&&(l>=R?l=f:E||(i[n]=R,r[n++]=f)))}}computeFov(e,t,i,r,s){if(this.originX=e,this.originY=t,this.radius=i,r)this.minX=Math.min(this.minX,Math.max(0,e-i)),this.minY=Math.min(this.minY,Math.max(0,t-i)),this.maxX=Math.max(this.maxX,Math.min(this.width-1,e+i)),this.maxY=Math.max(this.maxY,Math.min(this.height-1,t+i));else{this.minX=Math.max(0,e-i),this.minY=Math.max(0,t-i),this.maxX=Math.min(this.width-1,e+i),this.maxY=Math.min(this.height-1,t+i);for(let n=this.minY;n<=this.maxY;n++)for(let a=this.minX;a<=this.maxX;a++)this.grid[n][a].visible=!1}this.grid[t][e].visible=!0,s===void 0?(this.computeOctantY(1,1),this.computeOctantX(1,1),this.computeOctantX(1,-1),this.computeOctantY(1,-1),this.computeOctantY(-1,-1),this.computeOctantX(-1,-1),this.computeOctantX(-1,1),this.computeOctantY(-1,1)):(s&1&&this.computeOctantY(1,1),s&2&&this.computeOctantX(1,1),s&4&&this.computeOctantX(1,-1),s&8&&this.computeOctantY(1,-1),s&16&&this.computeOctantY(-1,-1),s&32&&this.computeOctantX(-1,-1),s&64&&this.computeOctantX(-1,1),s&128&&this.computeOctantY(-1,1))}updateExplored(){for(let e=this.minY;e<=this.maxY;e++)for(let t=this.minX;t<=this.maxX;t++){let i=this.grid[e][t];i.explored=i.explored||i.visible}}};F=B([K],F);var ht=class{constructor(e,t,i){this.url=e,this.charWidth=t,this.charHeight=i}},ut="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAQMAAAD58POIAAAABlBMVEUAAAD///+l2Z/dAAAEhklEQVRIx42Sv4oUQRDGC4UzadSwwMUD8QEKlbWD4Q58B/NGpTVocKO1wXHUzMAH0AcwMTYVGg5ag0IzEXaRjdZEZKNzkKbHqtnzHypY09M9+5uvqr7pbYCuC6ftaRhgONXs30eAh0O1rYDm4IS/eH0B8GxRW2vxo396yu/fb0ZFrW1zcOXlPU/XPwK8PGjbWhVwM4KnH61912oK4+zmmHJaQotyt1kvtC2Atdo24iohPDiG/v4eICJsY3Wy8Yvr0DSIBOdxgH6v8wsriWhc8s0AtaK/GzSl1jR0nSjQnwki6FQxNFKjgzO2a7BBqucH7dL4M9z96CIhT1Fs/AgKgcA6dKCxI29DaHNwRJ4EGAU1sU0OG9rmE4SIc3A4FChACqqhJRwpxkqh9wxag4DSmEJ5DtpFwAP4GUf6lmKcFFti1BYuQp4xN8kxM2kNhjdkTOiTUeAKGvhA1rLpMbYACQzCITlTDRMbLYoEa2JWPSMRFZIupcSzMVKcEUkX+sOG+ChNX2vD8ex6k7OFHL0P1655JuPd53WAD+yTv3UrCQiuHmYBbfIxpkImuvpBQBkVb5g4XHv3JkNireG8AO9zDhBZu2z2OMZ11S5/RIlyMefMNaZ4GsCz5xcjyM6hHYEjAYEfO8Ig1rklAe9sRIeYAdwyoIBq6YIzCAKiWoifA3m3o2AzWcdYKOdY47EIf8QABCuYgIUVmdVMEYEDA0Hmo/3D6KKJbh5mxhP3UsWIE97wnEygyizOfOLi2JOJW8CeOblW9IHeKZgv4zxuzDryOmb+4aQH+MXV6e0ywdUcxqCjBWl5GpbzZduOG1QEiGXP86T7EfiJfkMQ4OO4H0yqyNC2zlziWEN7Ywuc2fQ4p5BNkS5QYXP2h5NtRJh0vCKQidtVJmCGAwDSSQpYggSxiRIyzewsgCh4xxiTPDMh5aj//l7btqkr6rQyIOtLji4lVRQwXdzvus40Y53M33fh50GZwF4ExQeMlvuTggLzSi4ElKczUO7zVtpwdyMKdqZKOWb2nDblawPxPmuMwFEWBW+jlZR1eYtS442kiBGMWCi/h1/+GAR6NYOJWiqNJXFygFtrkx5C0O3IeFGs67HhEEhmBu/BUOT+0551pXxYIF+Elpi5AKRkLl5GUbCCZddyMv621ujEBPP4vSy2fotTx3U+d3WBiFOA6VSGSB49v/M7GBX9FPrDaT2c9qr4PCpwZ7qz813R94dVFIe19v33GlMZUghQFb8BrfE7QBmgBMbrn2B3enn/y3B5+DL8UBAdnejdYdBxeV9ejwoYNTgW0Ok/gA7UG2GAzanhL0DG7q4svynwF8UwDPu7u/vD0IudzSltMtVbP+J/gUbR29oJ7Fg9s6Uy+DnpiTCOYc4cXOeXMWfsusSw7FOg9x655nax6BlecwpOQQ68WBwp+H2LMQTuOq2RUigzh2Q/R3CWARJIJG199EwOTyKBlQMznshCRGeQ5gHABAQl6M4gLEdAzVaBWMCiANdsayDCHBA/hagKYfielrJIlipKKQIA9Nf3wBloTHT6BuAx15zRNa1nAAAAAElFTkSuQmCC",q=new ht(ut,8,8),g=class{constructor(e,t){this.x=e,this.y=t}};g=B([K],g);var b=class{constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}get left(){return this.x}get top(){return this.y}get x2(){return this.x+this.width}get y2(){return this.y+this.height}getCenter(){return new g(this.x+this.width/2|0,this.y+this.height/2|0)}intersects(e){return this.x<=e.x2&&this.x2>=e.x&&this.y<=e.y2&&this.y2>=e.y}contains(e){return e.x>=this.x&&e.x<this.x2&&e.y>=this.y&&e.y<this.y2}};b=B([K],b);var lt=66.66666666666667,ct=class{constructor(){this.down=!1,this.downTime=0,this.repeat=!1,this.repeatTime=0,this.downCount=0,this.upCount=100}setDown(e){this.down!==e&&(this.down=e,this.repeat=!1,this.downTime=this.repeatTime=performance.now())}update(e){this.repeat=!1,this.down?(this.downCount++,this.upCount=0,e-this.downTime>=200&&e-this.repeatTime>=lt&&(this.repeat=!0,this.repeatTime=e)):(this.downCount=0,this.upCount++)}isPressed(){return this.downCount===1||this.repeat}isClicked(){return this.upCount===1}},Z=class{constructor(){this.inputs=new Map}clear(){this.inputs.clear()}get(e){let t=this.inputs.get(e);return t||(t=new ct,this.inputs.set(e,t)),t}updateAll(e){this.inputs.forEach(t=>t.update(e))}},dt=class{constructor(e){this.keys=new Z,e.addEventListener("keydown",t=>this.setKey(t,!0)),e.addEventListener("keyup",t=>this.setKey(t,!1))}clear(){this.keys.clear()}getKey(e){return this.keys.get(e)}setKey(e,t){let i=e.code;i!==A.VK_F11&&(e.stopPropagation(),e.preventDefault(),this.keys.get(i).setDown(t))}updateKeys(e){this.keys.updateAll(e)}},A={VK_BACKSPACE:"Backspace",VK_TAB:"Tab",VK_ENTER:"Enter",VK_SHIFT_LEFT:"ShiftLeft",VK_SHIFT_RIGHT:"ShiftRight",VK_CONTROL_LEFT:"ControlLeft",VK_CONTROL_RIGHT:"ControlRight",VK_ALT_LEFT:"AltLeft",VK_ALT_RIGHT:"AltRight",VK_PAUSE:"Pause",VK_CAPS_LOCK:"CapsLock",VK_ESCAPE:"Escape",VK_SPACE:"Space",VK_PAGE_UP:"PageUp",VK_PAGE_DOWN:"PageDown",VK_END:"End",VK_HOME:"Home",VK_LEFT:"ArrowLeft",VK_UP:"ArrowUp",VK_RIGHT:"ArrowRight",VK_DOWN:"ArrowDown",VK_INSERT:"Insert",VK_DELETE:"Delete",VK_0:"Digit0",VK_1:"Digit1",VK_2:"Digit2",VK_3:"Digit3",VK_4:"Digit4",VK_5:"Digit5",VK_6:"Digit6",VK_7:"Digit7",VK_8:"Digit8",VK_9:"Digit9",VK_SEMICOLON:"Semicolon",VK_EQUALS:"Equal",VK_A:"KeyA",VK_B:"KeyB",VK_C:"KeyC",VK_D:"KeyD",VK_E:"KeyE",VK_F:"KeyF",VK_G:"KeyG",VK_H:"KeyH",VK_I:"KeyI",VK_J:"KeyJ",VK_K:"KeyK",VK_L:"KeyL",VK_M:"KeyM",VK_N:"KeyN",VK_O:"KeyO",VK_P:"KeyP",VK_Q:"KeyQ",VK_R:"KeyR",VK_S:"KeyS",VK_T:"KeyT",VK_U:"KeyU",VK_V:"KeyV",VK_W:"KeyW",VK_X:"KeyX",VK_Y:"KeyY",VK_Z:"KeyZ",VK_CONTEXT_MENU:"ContextMenu",VK_NUMPAD0:"Numpad0",VK_NUMPAD1:"Numpad1",VK_NUMPAD2:"Numpad2",VK_NUMPAD3:"Numpad3",VK_NUMPAD4:"Numpad4",VK_NUMPAD5:"Numpad5",VK_NUMPAD6:"Numpad6",VK_NUMPAD7:"Numpad7",VK_NUMPAD8:"Numpad8",VK_NUMPAD9:"Numpad9",VK_NUMPAD_ENTER:"NumpadEnter",VK_MULTIPLY:"NumpadMultiply",VK_ADD:"NumpadAdd",VK_SEPARATOR:"NumpadSeparator",VK_SUBTRACT:"NumpadSubtract",VK_DECIMAL:"NumpadDecimal",VK_DIVIDE:"NumpadDivide",VK_F1:"F1",VK_F2:"F2",VK_F3:"F3",VK_F4:"F4",VK_F5:"F5",VK_F6:"F6",VK_F7:"F7",VK_F8:"F8",VK_F9:"F9",VK_F10:"F10",VK_F11:"F11",VK_F12:"F12",VK_F13:"F13",VK_F14:"F14",VK_F15:"F15",VK_F16:"F16",VK_F17:"F17",VK_F18:"F18",VK_F19:"F19",VK_F20:"F20",VK_F21:"F21",VK_F22:"F22",VK_F23:"F23",VK_F24:"F24",VK_NUM_LOCK:"NumLock",VK_SCROLL_LOCK:"ScrollLock",VK_COMMA:"Comma",VK_PERIOD:"Period",VK_SLASH:"Slash",VK_BACKQUOTE:"Backquote",VK_OPEN_BRACKET:"BracketLeft",VK_BACK_SLASH:"Backslash",VK_CLOSE_BRACKET:"BracketRight",VK_QUOTE:"Quote",VK_META:"OSLeft"},_t=class{constructor(e){this.buttons=new Z,this.el=e.canvas,this.width=e.width,this.height=e.height,this.prevX=0,this.prevY=0,this.x=0,this.y=0,this.dx=0,this.dy=0,this.wheelDeltaX=0,this.wheelDeltaY=0;let t=this.el;t.addEventListener("mousedown",i=>this.handleEvent(i)),t.addEventListener("mouseup",i=>this.handleEvent(i)),t.addEventListener("mousemove",i=>this.handleEvent(i)),t.addEventListener("contextmenu",i=>this.handleEvent(i)),t.addEventListener("touchstart",i=>this.handleTouchEvent(i)),t.addEventListener("touchend",i=>this.handleTouchEvent(i)),t.addEventListener("touchcancel",i=>this.handleTouchEvent(i)),t.addEventListener("touchmove",i=>this.handleTouchEvent(i)),t.addEventListener("wheel",i=>this.handleWheelEvent(i))}handleTouchEvent(e){if(e.stopPropagation(),e.preventDefault(),e.touches.length>0){let t=e.touches[0];this.updatePosition(t.clientX,t.clientY),this.buttons.get(0).setDown(!0)}else this.buttons.get(0).setDown(!1)}handleEvent(e){e.stopPropagation(),e.preventDefault(),this.updatePosition(e.clientX,e.clientY),e.type==="mousedown"&&(this.buttons.get(e.button).setDown(!0),this.el.focus()),e.type==="mouseup"&&this.buttons.get(e.button).setDown(!1)}handleWheelEvent(e){e.stopPropagation(),e.preventDefault(),this.wheelDeltaX=e.deltaX,this.wheelDeltaY=e.deltaY}updatePosition(e,t){let i=this.el.getBoundingClientRect(),r=this.width/this.height,s=i.width/i.height;if(s-r>.01){let n=r*i.height,a=i.width-n;i=new b(Math.floor(a/2),0,n,i.height)}if(s-r<-.01){let n=i.width/r,a=i.height-n;i=new b(0,Math.floor(a/2),i.width,n)}this.x=this.width*(e-i.left)/i.width|0,this.y=this.height*(t-i.top)/i.height|0}update(e){this.dx=this.x-this.prevX,this.dy=this.y-this.prevY,this.prevX=this.x,this.prevY=this.y,this.buttons.updateAll(e)}};o(0,0,0),o(255,255,255),o(136,0,0),o(170,255,238),o(204,68,204),o(0,204,85),o(0,0,170),o(238,238,119),o(221,136,85),o(102,68,0),o(255,119,119),o(51,51,51),o(119,119,119),o(170,255,102),o(0,136,255),o(187,187,187);o(0,0,0),o(255,255,255),o(136,0,0),o(170,255,238),o(204,68,204),o(0,204,85),o(0,0,170),o(238,238,119),o(221,136,85),o(102,68,0),o(255,119,119),o(51,51,51),o(119,119,119),o(170,255,102),o(0,136,255),o(187,187,187);o(0,0,0),o(29,43,83),o(126,37,83),o(0,135,81),o(171,82,54),o(95,87,79),o(194,195,199),o(255,241,232),o(255,0,77),o(255,163,0),o(255,236,39),o(0,228,54),o(41,173,255),o(131,118,156),o(255,119,168),o(255,204,170);var H=class{constructor(e=1){this.m=2147483648,this.a=1103515245,this.c=12345,this.state=e}nextInt(){return this.state=(this.a*this.state+this.c)%this.m,this.state}nextFloat(){return this.nextInt()/(this.m-1)}nextRange(e,t){let i=t-e,r=this.nextInt()/this.m,s=e+(r*i|0);if(isNaN(s))throw new Error("rand nan");return s}chooseIndex(e){let t=e.reduce((s,n)=>s+n),i=this.nextRange(1,t+1),r=0;for(let s=0;s<e.length;s++)if(r+=e[s],i<=r)return s;return e.length-1}chooseKey(e){let t=Object.keys(e),i=t.map(r=>e[r]);return t[this.chooseIndex(i)]}};H=B([K],H);var mt=`#version 300 es
precision highp float;in vec2 a;in vec2 b;in vec3 c;in vec3 d;out vec2 e;out vec4 f;out vec4 g;void main(void){gl_Position=vec4(a.x,a.y,0,1);e=b/16.0;f=vec4(c.r,c.g,c.b,1);g=vec4(d.r,d.g,d.b,1);}`,ft=`#version 300 es
precision highp float;in vec2 e;in vec4 f;in vec4 g;uniform sampler2D s;out vec4 o;void main(void){o=texture(s,e);if(o.r<0.1) {o=g;} else {o=f;}}`,gt=`#version 300 es
precision highp float;
in vec2 a_position;
in vec2 a_texCoord;
out vec2 v_texCoord;
void main(void) {
  gl_Position=vec4(a_position.x, a_position.y, 0.0, 1.0);
  v_texCoord = a_texCoord;
}`,At=`#version 300 es
#define PI 3.1415926535897932384626433832795
precision highp float;
in vec2 v_texCoord;
uniform sampler2D u_texture;
uniform float u_blur;
uniform float u_curvature;
uniform float u_chroma;
uniform float u_scanlineWidth;
uniform float u_scanlineIntensity;
uniform float u_vignette;
out vec4 outputColor;

vec2 curve(vec2 uv) {
  uv = (uv - 0.5) * 2.0;
  uv *= 1.1;
  uv.x *= 1.0 + pow((abs(uv.y) * u_curvature), 2.0);
  uv.y *= 1.0 + pow((abs(uv.x) * u_curvature), 2.0);
  uv /= 1.1;
  uv = (uv / 2.0) + 0.5;
  return uv;
}

void main() {
  vec2 iResolution = vec2(640.0, 360.0);
  vec2 q = v_texCoord;
  vec2 fragCoord = v_texCoord;
  vec2 uv = q;
  uv = curve(uv);

  // Outside of range is black
  if (uv.x < 0.0 || uv.x > 1.0 || uv.y < 0.0 || uv.y > 1.0) {
    outputColor = vec4(0.0, 0.0, 0.0, 1.0);
    return;
  }

  vec4 col;

  // Chromatic aberration
  // col = texture(u_texture, uv.xy);
  col.r = 0.7 * texture(u_texture, vec2(uv.x + 0.001 * u_chroma, uv.y + 0.001 * u_chroma)).r;
  col.g = 0.7 * texture(u_texture, vec2(uv.x + 0.000 * u_chroma, uv.y - 0.002 * u_chroma)).g;
  col.b = 0.7 * texture(u_texture, vec2(uv.x - 0.002 * u_chroma, uv.y + 0.000 * u_chroma)).b;
  
  // Blur
  col += 0.05 * texture(u_texture, vec2(uv.x - 2.0 * u_blur / iResolution.x, uv.y));
  col += 0.10 * texture(u_texture, vec2(uv.x - 1.0 * u_blur / iResolution.x, uv.y));
  col += 0.10 * texture(u_texture, vec2(uv.x + 1.0 * u_blur / iResolution.x, uv.y));
  col += 0.05 * texture(u_texture, vec2(uv.x + 2.0 * u_blur / iResolution.x, uv.y));

  // Vignette
  col *= pow(16.0 * uv.x * uv.y * (1.0 - uv.x) * (1.0 - uv.y), u_vignette);

  // Scanlines
  col *= clamp(1.0 + u_scanlineWidth * sin(uv.y * iResolution.y * 2.0 * PI), 1.0 - u_scanlineIntensity, 1.0);

  outputColor = vec4(col.rgb, 1.0);
}`;function D(e,t){return-1+2*(e/t)}var j={[A.VK_K]:new g(0,-1),[A.VK_UP]:new g(0,-1),[A.VK_NUMPAD8]:new g(0,-1),[A.VK_J]:new g(0,1),[A.VK_DOWN]:new g(0,1),[A.VK_NUMPAD2]:new g(0,1),[A.VK_H]:new g(-1,0),[A.VK_LEFT]:new g(-1,0),[A.VK_NUMPAD4]:new g(-1,0),[A.VK_L]:new g(1,0),[A.VK_RIGHT]:new g(1,0),[A.VK_NUMPAD6]:new g(1,0),[A.VK_Y]:new g(-1,-1),[A.VK_NUMPAD7]:new g(-1,-1),[A.VK_U]:new g(1,-1),[A.VK_NUMPAD9]:new g(1,-1),[A.VK_B]:new g(-1,1),[A.VK_NUMPAD1]:new g(-1,1),[A.VK_N]:new g(1,1),[A.VK_NUMPAD3]:new g(1,1),[A.VK_PERIOD]:new g(0,0),[A.VK_NUMPAD5]:new g(0,0)},Et={font:q,movementKeys:j},pt=class extends F{constructor(e,t,i,r=Et){var _;super(t,i),this.canvas=e,this.font=r.font??q,this.crt=r.crt,this.maxFps=r.maxFps,this.pixelWidth=t*this.font.charWidth,this.pixelHeight=i*this.font.charHeight,this.pixelScale=((_=r.crt)==null?void 0:_.scale)??1,e.width=this.pixelWidth*this.pixelScale,e.height=this.pixelHeight*this.pixelScale,e.style.imageRendering="pixelated",e.style.outline="none",e.tabIndex=0,this.handleResize(),window.addEventListener("resize",()=>this.handleResize()),this.keys=new dt(e),this.mouse=new _t(this);let s=e.getContext("webgl2",{antialias:!1});if(!s)throw new Error("Unable to initialize WebGL. Your browser may not support it.");let n=s.createProgram();if(!n)throw new Error("Unable to initialize WebGL. Your browser may not support it.");this.gl=s,this.program=n,s.attachShader(n,this.buildShader(s.VERTEX_SHADER,mt)),s.attachShader(n,this.buildShader(s.FRAGMENT_SHADER,ft)),s.linkProgram(n),s.useProgram(n),this.crtProgram=s.createProgram(),s.attachShader(this.crtProgram,this.buildShader(s.VERTEX_SHADER,gt)),s.attachShader(this.crtProgram,this.buildShader(s.FRAGMENT_SHADER,At)),s.linkProgram(this.crtProgram),s.useProgram(this.crtProgram),this.crtBlurLocation=s.getUniformLocation(this.crtProgram,"u_blur"),this.crtCurvatureLocation=s.getUniformLocation(this.crtProgram,"u_curvature"),this.crtChromaLocation=s.getUniformLocation(this.crtProgram,"u_chroma"),this.crtScanlineWidthLocation=s.getUniformLocation(this.crtProgram,"u_scanlineWidth"),this.crtScanlineIntensityLocation=s.getUniformLocation(this.crtProgram,"u_scanlineIntensity"),this.crtVignetteLocation=s.getUniformLocation(this.crtProgram,"u_vignette"),this.crtPositionLocation=s.getAttribLocation(this.crtProgram,"a_position"),this.crtPositionBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.crtPositionBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),s.STATIC_DRAW),s.enableVertexAttribArray(this.crtPositionLocation),s.vertexAttribPointer(this.crtPositionLocation,2,s.FLOAT,!1,0,0),this.crtTexCoordLocation=s.getAttribLocation(this.crtProgram,"a_texCoord"),this.crtTexCoordBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.crtTexCoordBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),s.STATIC_DRAW),s.enableVertexAttribArray(this.crtTexCoordLocation),s.vertexAttribPointer(this.crtTexCoordLocation,2,s.FLOAT,!1,0,0),this.positionAttribLocation=this.getAttribLocation("a"),this.textureAttribLocation=this.getAttribLocation("b"),this.fgColorAttribLocation=this.getAttribLocation("c"),this.bgColorAttribLocation=this.getAttribLocation("d");let a=t*i;this.positionsArray=new Float32Array(a*3*4),this.indexArray=new Uint16Array(a*6),this.textureArray=new Float32Array(a*2*4),this.foregroundUint8Array=new Uint8Array(a*4*4),this.foregroundDataView=new DataView(this.foregroundUint8Array.buffer),this.backgroundUint8Array=new Uint8Array(a*4*4),this.backgroundDataView=new DataView(this.backgroundUint8Array.buffer),this.frameBufferTexture=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this.frameBufferTexture),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,this.pixelWidth,this.pixelHeight,0,s.RGBA,s.UNSIGNED_BYTE,null),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),this.frameBuffer=s.createFramebuffer(),s.bindFramebuffer(s.FRAMEBUFFER,this.frameBuffer),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.frameBufferTexture,0);let l=0,u=0,h=0;for(let c=0;c<i;c++)for(let d=0;d<t;d++)this.positionsArray[l++]=D(d,t),this.positionsArray[l++]=-D(c,i),this.positionsArray[l++]=D(d+1,t),this.positionsArray[l++]=-D(c,i),this.positionsArray[l++]=D(d+1,t),this.positionsArray[l++]=-D(c+1,i),this.positionsArray[l++]=D(d,t),this.positionsArray[l++]=-D(c+1,i),this.indexArray[u++]=h+0,this.indexArray[u++]=h+1,this.indexArray[u++]=h+2,this.indexArray[u++]=h+0,this.indexArray[u++]=h+2,this.indexArray[u++]=h+3,h+=4;this.positionBuffer=s.createBuffer(),this.indexBuffer=s.createBuffer(),this.textureBuffer=s.createBuffer(),this.foregroundBuffer=s.createBuffer(),this.backgroundBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.positionBuffer),s.bufferData(s.ARRAY_BUFFER,this.positionsArray,s.STATIC_DRAW),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this.indexBuffer),s.bufferData(s.ELEMENT_ARRAY_BUFFER,this.indexArray,s.STATIC_DRAW),this.texture=this.loadTexture(this.font.url),this.lastRenderTime=0,this.renderDelta=0,this.fps=0,this.averageFps=0,this.maxFps===void 0?this.requestAnimationFrame():window.setInterval(()=>this.renderLoop(performance.now()),1e3/this.maxFps)}handleResize(){let e=this.canvas.parentElement;if(!e)return;let t=e.offsetWidth/this.pixelWidth,i=e.offsetHeight/this.pixelHeight,r=Math.min(t,i),s=r*this.pixelWidth|0,n=r*this.pixelHeight|0;this.canvas.style.width=s+"px",this.canvas.style.height=n+"px"}getAttribLocation(e){let t=this.gl.getAttribLocation(this.program,e);return this.gl.enableVertexAttribArray(t),t}flush(){let e=0,t=0;for(let i=0;i<this.height;i++)for(let r=0;r<this.width;r++){let s=this.getCell(r,i);if(!s.dirty){e+=8,t+=16;continue}let n=s.charCode%16,a=s.charCode/16|0;this.textureArray[e++]=n,this.textureArray[e++]=a,this.textureArray[e++]=n+1,this.textureArray[e++]=a,this.textureArray[e++]=n+1,this.textureArray[e++]=a+1,this.textureArray[e++]=n,this.textureArray[e++]=a+1;for(let l=0;l<4;l++)this.foregroundDataView.setUint32(t,s.fg,!1),this.backgroundDataView.setUint32(t,s.bg,!1),t+=4;s.dirty=!1}}isKeyDown(e){return this.keys.getKey(e).down}isKeyPressed(e){return this.keys.getKey(e).isPressed()}getKeyDownCount(e){return this.keys.getKey(e).downCount}getMovementKey(e=j){for(let[t,i]of Object.entries(e))if(this.isKeyPressed(t))return i}buildShader(e,t){let i=this.gl,r=i.createShader(e);if(!r)throw new Error("An error occurred compiling the shader: ");if(i.shaderSource(r,t),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS))throw new Error("An error occurred compiling the shader: "+i.getShaderInfoLog(r));return r}loadTexture(e){let t=this.gl,i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i);let r=0,s=t.RGBA,n=1,a=1,l=0,u=t.RGBA,h=t.UNSIGNED_BYTE,_=new Uint8Array([0,0,0,255]);t.texImage2D(t.TEXTURE_2D,r,s,n,a,l,u,h,_);let c=new Image;return c.onload=()=>{t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,r,s,u,h,c),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST)},c.src=e,i}render(){let e=this.gl;e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.crt?e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,this.pixelWidth,this.pixelHeight);{let t=e.FLOAT;e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.vertexAttribPointer(this.positionAttribLocation,2,t,!1,0,0)}{let t=e.FLOAT;e.bindBuffer(e.ARRAY_BUFFER,this.textureBuffer),e.bufferData(e.ARRAY_BUFFER,this.textureArray,e.DYNAMIC_DRAW),e.vertexAttribPointer(this.textureAttribLocation,2,t,!1,0,0)}{let t=e.UNSIGNED_BYTE;e.bindBuffer(e.ARRAY_BUFFER,this.foregroundBuffer),e.bufferData(e.ARRAY_BUFFER,this.foregroundUint8Array,e.DYNAMIC_DRAW),e.vertexAttribPointer(this.fgColorAttribLocation,4,t,!0,0,0)}{let t=e.UNSIGNED_BYTE;e.bindBuffer(e.ARRAY_BUFFER,this.backgroundBuffer),e.bufferData(e.ARRAY_BUFFER,this.backgroundUint8Array,e.DYNAMIC_DRAW),e.vertexAttribPointer(this.bgColorAttribLocation,4,t,!0,0,0)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.useProgram(this.program),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture);{let t=this.width*this.height*6,i=e.UNSIGNED_SHORT;e.drawElements(e.TRIANGLES,t,i,0)}}renderCrt(){let e=this.crt;if(!e)return;let t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,this.pixelWidth*this.pixelScale,this.pixelHeight*this.pixelScale),t.useProgram(this.crtProgram),t.uniform1f(this.crtBlurLocation,e.blur),t.uniform1f(this.crtCurvatureLocation,e.curvature),t.uniform1f(this.crtChromaLocation,e.chroma),t.uniform1f(this.crtVignetteLocation,e.vignette),t.uniform1f(this.crtScanlineWidthLocation,e.scanlineWidth),t.uniform1f(this.crtScanlineIntensityLocation,e.scanlineIntensity),t.bindBuffer(t.ARRAY_BUFFER,this.crtPositionBuffer),t.vertexAttribPointer(this.crtPositionLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.crtTexCoordBuffer),t.vertexAttribPointer(this.crtTexCoordLocation,2,t.FLOAT,!1,0,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.frameBufferTexture),t.drawArrays(t.TRIANGLES,0,6)}requestAnimationFrame(){window.requestAnimationFrame(e=>this.renderLoop(e))}renderLoop(e){this.lastRenderTime===0?(this.lastRenderTime=e,this.fps=0):(this.renderDelta=e-this.lastRenderTime,this.lastRenderTime=e,this.fps=1e3/this.renderDelta,this.averageFps=.95*this.averageFps+.05*this.fps),this.keys.updateKeys(e),this.mouse.update(e),this.update&&this.update(),this.flush(),this.render(),this.crt&&this.renderCrt(),this.maxFps===void 0&&this.requestAnimationFrame()}};class w{pause(){}draw(t,i){return 0}static text(t,i=0,r=O.WHITE){return t=`${" ".repeat(i)}${t[0].toUpperCase()}${t.slice(1)}`,new Lt(t,r)}static begin(t,i){const r=`${t.definiteName} and ${i.definiteName} close in and begin to fight!`;return this.text(r)}static status(t,i){function r(n){return`${n.name}: ${n.hp}/${n.maxHp()} HP`}const s=`(${r(i)} ${r(t)})`;return this.text(s,0,O.LIGHT_GRAY)}static death(t){const i=`${t.definiteName} has been killed!`;return this.text(i)}static intro(t){const i=`${t.indefiniteName} wielding ${t.weapon.indefiniteName} approaches!`;return this.text(i)}static conclusion(t,i,r){const s=`After killing ${t-1} ${i.name}s, ${r.name} died.`;return this.text(s)}static pause(t){return new Rt(t)}static stumble(t,i,r){const s=t;return this.text(s,2)}static hit(t,i,r,s){const n=t;return this.text(n,2)}static miss(t,i,r){const s=t;return this.text(s,2)}}class Rt extends w{constructor(t){super(),this.seconds=t}pause(){return this.seconds}}class Lt extends w{constructor(t,i=O.WHITE){super(),this.text=t,this.fg=i}draw(t,i){return t.drawString(0,i,this.text,this.fg),1}}class wt{constructor(t){T(this,"events",[]);this.hero=t}emit(t){this.events.push(t)}}function xt(e){const t=e.split("d"),i=t[1].split("+"),r=parseInt(t[0]),s=parseInt(i[0]);let n=0;return i.length===2&&(n=parseInt(i[1])),[r,s,n]}function J(e){const[t,i,r]=xt(e);return tt(t,i,r)}function $(e,t){return Math.floor(Math.random()*(t-e+1))+e}function v(e){return e[$(0,e.length-1)]}function tt(e,t,i=0){let r=0;for(let s=0;s<e;s++)r+=$(1,t);return r+i}var y=(e=>(e.male="MALE",e.female="FEMALE",e.neuter="NEUTER",e.you="YOU",e))(y||{});const Tt={MALE:{himself:"himself",his:"his",him:"him",he:"he"},FEMALE:{himself:"herself",his:"her",him:"her",he:"she"},NEUTER:{himself:"itself",his:"its",him:"it",he:"it"},YOU:{himself:"yourself",his:"your",him:"you",he:"you"}};class vt{constructor(t,i){T(this,"dict",{});this.subject=t,this.object=i}makePronounDict(t,i){const r=i||"",s=Tt[t];for(const[n,a]of Object.entries(s))this.dict[r+n]=a}fillDict(t,i,r){const s=r||"";t===i?(this.makePronounDict("YOU",s),this.dict[s+"name"]="you",this.dict[s+"name_pos"]="your"):(this.makePronounDict(t.gender,s),this.dict[s+"name"]=t.name,this.dict[s+"name_pos"]=`${t.name}'s`)}}function Dt(e,t){return e.replace(/%\(([a-zA-Z0-9_]+)\)s/g,function(i,r){return t[r].toString()})}function Bt(e,t,i){const r=/\[(.*?)(\|(.+?))?\]/g,s=/\<(.*?)(\|(.+?))?\>/g;function n(a,l,u){return a.replace(l,(h,_,c)=>u?c?c.slice(1):"":_)}return e=n(e,r,t),n(e,s,i)}class Kt{constructor(t){this.viewer=t}makeGrammarDict(t,i){let r=new vt(t,i);return r.fillDict(t,this.viewer),r.fillDict(i,this.viewer,"o_"),r}parseString(t,i){const r=i.subject==this.viewer,s=i.object==this.viewer;return t=Bt(t,r,s),Dt(t,i.dict)}}class Ot{constructor(t,i){this.view=t,this.events=i}hit(t,i,r,s,n){const a=t.weapon,l=r/i.hp;let u,h,_;const c=this.view.makeGrammarDict(t,i);c.dict.weapon=t.weapon.name,c.dict.o_weapon=i.weapon.name,l<.15?h=v(a.words.light):l<.5?h=v(a.words.medium):(h=v(a.words.heavy),l<1?u=v(i.parts.heavy):u=v(i.parts.fatal)),(t.weapon.isAttackRollCrit(s)||l>=.8)&&(n==1?_=v(t.stumbles[0]):_=v(t.stumbles[1]),_=this.view.parseString(_,c),this.events.emit(w.stumble(_,t,i)),this.events.emit(w.pause(1))),u?h="%(name)s "+h+" %(o_name_pos)s "+u:h="%(name)s "+h+" %(o_name)s",h+=" for "+r+" damage!",h=this.view.parseString(h,c),this.events.emit(w.hit(h,t,i,r))}miss(t,i){var r=this.view.makeGrammarDict(t,i),s="%(name)s misses %(o_name)s!";s=this.view.parseString(s,r),this.events.emit(w.miss(s,t,i))}}class Nt{constructor(t,i){T(this,"dieRoll");this.narrator=t,this.maybeDieRoll=i,this.dieRoll=i||(()=>J("1d20"))}oneAttack(t,i,r,s){const n=this.dieRoll(),a=n+r+t.str,l=i.armorClass();if(i.hp!=0)if(a>=l){const u=t.weapon.damageRoll(n);this.narrator.hit(t,i,u,n,s),i.loseHp(u)}else this.narrator.miss(t,i)}executeTurn(t,i){const r=t.baseAttackBonus();this.oneAttack(t,i,r[0],1);for(let s=1;s<r.length;s++)this.narrator.events.emit(w.pause(2)),this.oneAttack(t,i,r[s],1+s)}}const bt=[[1],[2],[3],[4],[5],[6,1],[7,2],[8,3],[9,4],[10,5],[11,6,1],[12,7,2],[13,8,3],[14,9,4],[15,10,5],[16,11,6,1],[17,12,7,2],[18,13,8,3],[19,14,9,4],[20,15,10,5]];class et{constructor(t,i,r=y.neuter){T(this,"definiteName");T(this,"indefiniteName");this.name=t,this.isUnique=i,this.gender=r,i?(this.definiteName=t,this.indefiniteName=t):(this.definiteName="the "+t,t.match(/^[aeiou]/)?this.indefiniteName="an "+t:this.indefiniteName="a "+t)}}class it extends et{constructor(i,r){super(i,r);T(this,"wearer")}}class yt extends it{constructor(t,i,r,s,n,a){super(t,i),this.damage=r,this.words=s,this.critRange=n,this.critMultiplier=a}isAttackRollCrit(t){return t>=20-this.critRange}damageRoll(t){let i=1,r=0;this.isAttackRollCrit(t)&&(i=this.critMultiplier);for(let s=0;s<i;s++)r+=J(this.damage)+this.wearer.str;return r}}class Ct extends it{constructor(t,i,r){super(t,i),this.armorBonus=r}}class X extends et{constructor(i,r,s,n,a,l,u,h,_,c){super(i,s,r);T(this,"maxBaseHp");T(this,"weapon");T(this,"armor");this.level=n,this.str=a,this.con=l,this.dex=u,this.hp=h,this.parts=_,this.stumbles=c,this.maxBaseHp=h,this.fullyHeal()}equipWeapon(i){i.wearer=this,this.weapon=i}equipArmor(i){i.wearer=this,this.armor=i}armorClass(){var i;return 10+(((i=this.armor)==null?void 0:i.armorBonus)||0)+this.dex}baseAttackBonus(){return bt[this.level-1]}check(i){return tt(1,20)+this[i]}maxHp(){return this.maxBaseHp+this.con*this.level}fullyHeal(){this.hp=this.maxHp()}loseHp(i){this.hp-=i,this.hp<0&&(this.hp=0)}}const Ut={light:["scrape[s]","scratch[es]","graze[s]","minorly wound[s]"],medium:["cut[s] into","wound[s]","maul[s]"],heavy:["tear[s] into","rip[s] into","drive[s] %(his)s %(weapon)s into","thrust[s] %(his)s %(weapon)s into"]},I={light:["scrape[s]","scratch[es]","graze[s]","head-butt[s]","punch[es]","kick[s]"],medium:["cut[s] into","wound[s]","slash[es]","slice[s]","stab[s]"],heavy:["tear[s] into","drive[s] %(his)s %(weapon)s into","thrust[s] %(his)s %(weapon)s into","skewer[s]","run[s] %(his)s %(weapon)s through"]},Y={light:["strike[s]","glance[s]","slap[s]"],medium:["pound[s]","beat[s]","batter[s]","hammer[s]","slug[s]"],heavy:["hurl[s] %(his)s %(weapon)s into","hammer[s] %(his)s %(weapon)s into","drive[s] %(his)s %(weapon)s into"]},k=[["%(o_name)s tr<ies|y> to anticipate %(name_pos)s attack, but miscalculate<s>...","%(o_name)s <is|are> caught off-guard for a moment...!","%(o_name)s tr<ies|y> to dodge %(name_pos)s attack, but stumble<s>...","Weary from battle, %(o_name)s stagger<s> for a moment...","%(name)s trip[s] %(o_name)s and %(o_he)s fall<s> to the ground!","%(name)s launch[es] %(himself)s at %(o_name)s!"],["%(o_name)s make<s> a feeble attempt to block %(name_pos)s next attack...","%(o_name)s moan<s>...","%(o_name)s reel<s> from the shock...","%(o_name)s stagger<s>...","%(o_name)s fall<s> to %(o_his)s knees!","%(name)s trip[s] %(o_name)s and %(o_he)s fall<s> to the ground!"]],W={light:["fingers","hand","shoulder","arm","foot","leg"],medium:["right arm","left arm","right leg","left leg","side","flank"],heavy:["thigh","stomach","knee","midsection","torso","ribcage","back"],fatal:["chest","head","neck","spine","skull","eyes"]},S={maceAndChain:{name:"mace and chain",damage:"1d8",critRange:0,critMultiplier:2,words:Y},warhammer:{name:"warhammer",damage:"1d8",critRange:0,critMultiplier:3,words:Y},greatsword:{name:"greatsword",damage:"2d6",critRange:1,critMultiplier:2,words:I},longsword:{name:"longsword",damage:"1d8",critRange:1,critMultiplier:2,words:I},dagger:{name:"dagger",damage:"1d4",critRange:1,critMultiplier:2,words:Ut},battleaxe:{name:"battleaxe",damage:"1d8",critRange:0,critMultiplier:3,words:I}},It=Object.keys(S);function z(e){const t=e||S[v(It)];return new yt(t.name,!1,t.damage,t.words,t.critRange,t.critMultiplier)}const C={cloth:{name:"cloth",armorBonus:0},padded:{name:"padded",armorBonus:1},leather:{name:"leather",armorBonus:2},chainShirt:{name:"chain shirt",armorBonus:4},chainmail:{name:"chainmail",armorBonus:5},splintMail:{name:"splint mail",armorBonus:6},halfPlate:{name:"half plate",armorBonus:7},fullPlate:{name:"full plate",armorBonus:8}},Vt=Object.keys(C);function Q(e){const t=e||C[v(Vt)];return new Ct(t.name,!1,t.armorBonus)}window.addEventListener("DOMContentLoaded",()=>{const t={scale:6,blur:.5,curvature:.1,chroma:.5,vignette:.15,scanlineWidth:.75,scanlineIntensity:.25},i=new pt(document.querySelector("canvas"),80,45,{crt:t}),r=new X("Boromir",y.male,!0,15,17,17,13,104,W,k);r.equipWeapon(z(S.longsword)),r.equipArmor(Q(C.chainShirt));function s(){const f=new X("orc",y.male,!1,4,15,13,12,30,W,k);return f.equipWeapon(z()),f.equipArmor(Q(C.cloth)),f}const n=new wt(r),a=new Kt,l=new Ot(a,n),u=new Nt(l);function h(f,p){const m=[[f,p],[p,f]];for(p.dex>=f.dex&&m.reverse(),n.emit(w.begin(f,p)),n.emit(w.pause(2));;){n.emit(w.status(f,p));for(let N=0;N<m.length;N++){const P=m[N][0],U=m[N][1];if(P.hp&&u.executeTurn(P,U),U.hp===0){n.emit(w.death(U));return}n.emit(w.pause(3))}}}let _=0,c=s();for(;r.hp>0;_++)n.emit(w.intro(c)),h(c,r),n.emit(w.pause(3)),r.hp>0&&(c=s());n.emit(w.conclusion(_,c,r));let d=0;setInterval(()=>{d++},1e3);let E=0,x=[],R=0;i.update=()=>{if(d>=R){const p=n.events[E].pause();p?R=d+p:x.push(E),E++}i.clear();let f=0;for(let p of x.slice(-45))f+=n.events[p].draw(i,f)}});
